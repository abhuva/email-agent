{# ============================================================================
   V3 Email Note Template
   ============================================================================
   
   This template generates Markdown notes from email content and classification
   results. It follows the PDD Section 3.2 specification for frontmatter structure.
   
   Template Variables Available:
   - Email Data: uid, subject, from, to, date, body, html_body, headers
   - Classification: is_important, is_spam, importance_score, spam_score,
                     confidence, status, tags
   - LLM Output: llm_output.importance_score, llm_output.spam_score,
                 llm_output.model_used
   - Processing: processing_meta.script_version, processing_meta.processed_at,
                 processing_meta.status
   - Configuration: importance_threshold, spam_threshold
   
   Customization:
   - Modify this template to change the structure and formatting of generated notes
   - All Jinja2 syntax is supported (conditionals, loops, filters, etc.)
   - Custom filters available: format_date, format_datetime, truncate
   - See documentation in docs/ for more details
   
   Reference: PDD Section 3.2 (pdd.md)
   ============================================================================ #}
{# ============================================================================
   YAML Frontmatter Section - PDD Section 3.2
   ============================================================================
   This section contains all email metadata in YAML format. The frontmatter is
   enclosed between --- markers and will be parsed by Markdown processors.
   
   Field Descriptions:
   - uid: Unique email identifier from IMAP server
   - subject: Email subject line (sanitized)
   - from: Sender email address
   - to: List of recipient email addresses
   - date: Email date in ISO format (YYYY-MM-DDTHH:MM:SSZ)
   - tags: List of tags (automatically includes "email", "important" if score >= threshold)
   - llm_output: Classification results from LLM
     - importance_score: 0-10 score for email importance
     - spam_score: 0-10 score for spam likelihood
     - model_used: LLM model identifier
   - processing_meta: Processing metadata
     - script_version: Version of processing script (always "3.0" for V3)
     - processed_at: ISO timestamp of processing
     - status: "success" or "error"
   ============================================================================ #}
---
{# Email Identification #}
uid: {{ uid }}
{# Email subject - use yaml_string filter to properly escape quotes and special characters #}
subject: {{ subject | yaml_string }}
{# Sender name and email (separated to avoid YAML parsing issues) #}
{# Use YAML string format - Jinja2 will handle quoting automatically #}
from_name: {{ from_name | yaml_string }}
from_mail: {{ from_mail | yaml_string }}
{# Recipient addresses - parsed to extract just email addresses #}
to: {{ to | yaml_string }}
{# Email date - formatted to ISO 8601 format #}
date: "{{ date | format_datetime }}"
{# Tags - automatically includes "email" and "important" if importance_score >= threshold #}
{# The tags are generated by ClassificationResult.to_frontmatter_dict() #}
tags: {{ tags | tojson }}
{# LLM Classification Output #}
{# Importance score: 0-10, where higher = more important #}
{# Scores >= importance_threshold (default: 8) trigger "important" tag #}
importance_score: {{ importance_score }}
{# Spam score: 0-10, where higher = more likely spam #}
{# Scores >= spam_threshold (default: 5) trigger "spam" tag #}
spam_score: {{ spam_score }}
{# Confidence score: 0.0-1.0 confidence level in classification #}
{# NOTE: This is calculated locally (not from LLM) based on distance from thresholds. #}
{# Higher distance from threshold = higher confidence. See src/decision_logic.py for details. #}
confidence_score: {{ confidence }}
{# LLM model identifier used for classification #}
model_used: "{{ llm_output.model_used }}"
{# Processing Metadata #}
{# Script version - always "3.0" for V3 implementation #}
script_version: "3.0"
{# ISO timestamp when email was processed #}
processed_at: "{{ processing_meta.processed_at }}"
{# Processing status: "success" for successful classification, "error" for failures #}
status: "{{ status }}"
---
{# ============================================================================
   Email Summary Section
   ============================================================================
   Displays AI-generated summary for important emails if summarization was
   successful. The summary appears in a callout format at the top of the note,
   before the email body content.
   
   The summary is the raw LLM response inserted directly, preserving the
   model's natural formatting (including any action items, priority, etc.
   that the model includes in its response).
   ============================================================================ #}
{% if summary.has_summary %}
>[!summary] **Email Summary**
>{{ summary.summary_text }}
{% elif summary.success %}
{# Debug: Show summary data even if has_summary is False (for troubleshooting) #}
> [!warning] **Summary Generated but Empty**
> Summary was generated (success=True) but summary_text is empty or has_summary check failed.
> Debug: success={{ summary.success }}, has_summary={{ summary.has_summary }}, summary_length={{ summary.summary_text|length }}
{% endif %}

{# ============================================================================
   Main Email Content Section
   ============================================================================
   This section contains the rendered email content in Markdown format.
   ============================================================================ #}

{# Email Subject as Main Heading #}
# {{ subject }}

{# ============================================================================
   Email Metadata Section
   ============================================================================
   Displays key email metadata in a readable format. Customize the formatting
   here to change how sender, recipient, and date are displayed.
   ============================================================================ #}
**From:** {% if from_name %}{{ from_name }} <{{ from_mail }}>{% else %}{{ from_mail }}{% endif %}  
**To:** {{ to | join(', ') }}  
**Date:** {{ date }}

{# ============================================================================
   Classification Indicators
   ============================================================================
   Visual indicators that appear conditionally based on classification results.
   These help users quickly identify important emails and potential spam.
   
   Customization:
   - Modify the emoji and text to match your preferences
   - Add additional conditional sections for other classifications
   - Change the blockquote formatting (>) to other Markdown elements
   ============================================================================ #}

{# Important Email Indicator - appears if importance_score >= threshold #}
{% if is_important %}
> âš ï¸ **Important Email** (Score: {{ importance_score }}/10, Threshold: {{ importance_threshold }})
{% endif %}

{# Spam Email Warning - appears if spam_score >= threshold #}
{% if is_spam %}
> ðŸš¨ **Spam Email** (Score: {{ spam_score }}/10, Threshold: {{ spam_threshold }})
{% endif %}

{# Processing Error Indicator - appears if classification failed #}
{% if status == 'error' %}
> âŒ **Processing Error** - Classification failed
{% endif %}

{# ============================================================================
   Classification Details Section
   ============================================================================
   Detailed classification information. Only shown when classification was
   successful (status == 'success'). Customize this section to show more or
   less detail based on your needs.
   
   Available variables:
   - importance_score: 0-10 importance score
   - spam_score: 0-10 spam score
   - confidence: 0.0-1.0 confidence level
   - is_important: boolean (true if score >= threshold)
   - is_spam: boolean (true if score >= threshold)
   - importance_threshold: configured threshold value
   - spam_threshold: configured threshold value
   ============================================================================ #}
{% if status == 'success' %}
## Classification Details

- **Importance Score:** {{ importance_score }}/10 {% if is_important %}(Above threshold: {{ importance_threshold }}){% endif %}
- **Spam Score:** {{ spam_score }}/10 {% if is_spam %}(Above threshold: {{ spam_threshold }}){% endif %}
- **Confidence:** {{ "%.1f" | format(confidence * 100) }}%
- **Model Used:** {{ llm_output.model_used }}
{% endif %}

{# ============================================================================
   Email Body Section
   ============================================================================
   The main email content. This section handles:
   - Plain text body (preferred)
   - HTML body (fallback, truncated)
   - Empty content (shows placeholder)
   
   Customization:
   - Modify formatting for quoted replies/forwards
   - Add HTML to Markdown conversion if needed
   - Change truncation length for HTML fallback
   ============================================================================ #}
## Content

{% if body %}
{# Plain text body available - preferred format #}
{{ body }}
{% elif html_body %}
{# HTML body available but no plain text - truncated for safety #}
{# Note: Full HTML to Markdown conversion would require additional processing #}
{{ html_body | truncate(500) }}
{% else %}
{# No content available #}
*No content available*
{% endif %}

{# ============================================================================
   Attachments Section
   ============================================================================
   Placeholder for attachment handling. Currently checks for Content-Disposition
   header. Future versions may include full attachment metadata.
   
   Customization:
   - Add attachment list rendering when attachment data is available
   - Include attachment metadata (filename, size, type)
   ============================================================================ #}
{% if headers.get('Content-Disposition') %}
## Attachments

*Attachments would be listed here if available*
{% endif %}
