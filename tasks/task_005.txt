# Task ID: 5
# Title: Implement Google OAuth provider
# Status: pending
# Dependencies: 2, 4
# Priority: medium
# Description: Create the Google-specific OAuth implementation
# Details:
In `src/auth/providers/google.py`:
1. Implement `GoogleOAuthProvider` class that extends the base provider interface
2. Use `google-auth-oauthlib` library for OAuth flow
3. Implement methods for:
   - Generating authorization URL with correct scope: `https://mail.google.com/`
   - Handling authorization code callback
   - Exchanging code for tokens
   - Refreshing tokens
4. Read client ID and secret from environment variables: `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET`
5. Handle error cases gracefully with informative messages

# Test Strategy:
Write unit tests with mocked Google API responses. Test authorization URL generation, token exchange, and refresh flows. Verify correct scopes are requested. Test error handling with various API error responses.

# Subtasks:
## 1. Set up Google OAuth credentials and environment configuration [pending]
### Dependencies: None
### Description: Create and configure Google OAuth 2.0 credentials in Google Cloud Console, then implement environment variable loading for client ID and secret.
### Details:
1. Create OAuth 2.0 client ID in Google Cloud Console by setting up the OAuth consent screen with app name and support email[1][2]
2. Configure authorized redirect URI to match your application's callback endpoint (e.g., `/authorize` or `/oauth2callback`)[1][4]
3. Download client credentials and extract client ID and client secret
4. Create `.env` file with `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET` environment variables
5. Implement environment variable loading in `src/auth/providers/google.py` using `os.getenv()` with validation to ensure both variables are present
6. Add error handling to raise informative exceptions if credentials are missing at initialization time

## 2. Create GoogleOAuthProvider class structure with base interface implementation [pending]
### Dependencies: None
### Description: Define the GoogleOAuthProvider class that extends the base OAuth provider interface with required method signatures.
### Details:
1. Create `GoogleOAuthProvider` class in `src/auth/providers/google.py` that inherits from the base provider interface
2. Define class attributes for storing client ID, client secret, and redirect URI
3. Implement `__init__` method that accepts configuration parameters and initializes the provider with environment variables from subtask 1
4. Define method signatures for: `get_authorization_url()`, `handle_callback()`, `exchange_code_for_tokens()`, and `refresh_access_token()`
5. Add a private method `_validate_configuration()` to verify all required credentials are available
6. Include docstrings for all methods describing parameters, return values, and potential exceptions

## 3. Implement authorization URL generation with correct scopes [pending]
### Dependencies: 5.1, 5.2
### Description: Implement the method to generate Google OAuth authorization URLs with proper scope configuration for Gmail access.
### Details:
1. Use `google_auth_oauthlib.flow.Flow.from_client_secrets_file()` or construct Flow manually with client credentials[3]
2. Configure scopes to include `https://mail.google.com/` as specified, plus `openid`, `email`, and `profile` for user identification[1][3]
3. Set the redirect URI to match the value configured in Google Cloud Console and environment
4. Implement `get_authorization_url()` method that returns the authorization URL string
5. Store the Flow object as an instance variable for use in subsequent token exchange steps
6. Add error handling for invalid configuration or Flow initialization failures with descriptive error messages

## 4. Implement authorization code callback handling and token exchange [pending]
### Dependencies: 5.2, 5.3
### Description: Implement the callback handler that receives authorization codes and exchanges them for access and refresh tokens.
### Details:
1. Implement `handle_callback()` method that accepts the authorization code from the redirect URI[4]
2. Validate the authorization code format and presence
3. Use `flow.fetch_token()` method to exchange the authorization code for tokens[4]
4. Extract and store access token, refresh token, and token expiration time from the response
5. Implement `exchange_code_for_tokens()` method that returns a structured token object containing: access_token, refresh_token, expires_in, and token_type
6. Add comprehensive error handling for: invalid codes, network failures, and Google API errors with user-friendly error messages

## 5. Implement token refresh mechanism with expiration handling [pending]
### Dependencies: 5.2, 5.4
### Description: Implement the token refresh functionality to maintain valid access tokens and handle token expiration scenarios.
### Details:
1. Implement `refresh_access_token()` method that accepts a refresh token as input
2. Use the stored Flow object or create a new credentials object from the refresh token
3. Call the appropriate Google Auth library method to refresh the access token
4. Return updated token information including new access token, expiration time, and any updated refresh token
5. Implement token expiration checking logic that determines if a token needs refresh (e.g., if expiration is within 5 minutes)
6. Add error handling for: invalid refresh tokens, revoked credentials, and network failures with clear error messages indicating whether the user needs to re-authenticate

## 6. Add comprehensive error handling, logging, and unit tests [pending]
### Dependencies: 5.1, 5.2, 5.3, 5.4, 5.5
### Description: Implement error handling throughout the provider, add logging for debugging, and create unit tests for all major components.
### Details:
1. Add try-catch blocks around all Google API calls with specific exception handling for: `google.auth.exceptions.GoogleAuthError`, network errors, and invalid credentials
2. Implement logging using Python's `logging` module to track: authorization URL generation, token exchanges, refreshes, and errors
3. Create custom exception classes for Google OAuth-specific errors (e.g., `GoogleOAuthError`, `TokenRefreshError`)
4. Write unit tests covering: successful authorization URL generation, valid token exchange, token refresh with valid refresh token, token refresh with expired/invalid token, missing environment variables, and network failure scenarios
5. Add integration tests that verify the complete OAuth flow from authorization to token refresh
6. Document error codes and troubleshooting steps in code comments and docstrings for maintainability

