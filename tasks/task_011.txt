# Task ID: 11
# Title: Update account processor for OAuth support
# Status: pending
# Dependencies: 3, 9
# Priority: high
# Description: Modify the account processor to create the appropriate authenticator based on configuration
# Details:
In `src/account_processor.py`:
1. Update the code that initializes the IMAP client to:
   - Read the `auth` block from account configuration
   - Determine the authentication method (password or OAuth)
   - Create the appropriate authenticator:
     - For password: create `PasswordAuthenticator` with email and password
     - For OAuth: create `OAuthAuthenticator` with email, account name, provider, and TokenManager
   - Pass the authenticator to the IMAP client
2. Ensure backward compatibility by defaulting to password authentication if `auth` block is missing
3. Add appropriate error handling for missing or invalid configurations

# Test Strategy:
Write unit tests for the account processor with various configurations. Test both password and OAuth authentication methods. Verify backward compatibility with existing configurations. Test error handling for missing or invalid configurations.

# Subtasks:
## 1. Implement configuration parsing for auth block with backward compatibility [pending]
### Dependencies: None
### Description: Update the account configuration reader to parse the new `auth` block structure while maintaining backward compatibility for existing password-only configs.
### Details:
1. Add `auth` field validation to config schema (email, password OR oauth: {account_name, provider, token_manager})
2. Implement fallback logic: if `auth` missing, construct legacy password auth from `email`/`password` fields
3. Add `get_auth_config()` method returning dict with `method` ('password'|'oauth') and auth params
4. Log deprecation warning for legacy password configs
5. Add unit tests for: valid password config, valid OAuth config, missing auth block fallback, invalid schema

## 2. Create PasswordAuthenticator and OAuthAuthenticator factory classes [pending]
### Dependencies: 11.1
### Description: Implement abstract Authenticator base class and concrete implementations for both authentication methods.
### Details:
1. Define `Authenticator` abstract base class with `authenticate(imap_client)` method
2. Implement `PasswordAuthenticator`:
   - Uses `imap_client.login(email, password)`
   - Simple error wrapping
3. Implement `OAuthAuthenticator`:
   - Uses `imap_client.authenticate('XOAUTH2', self._get_xoauth2_string)` per Microsoft spec[1]
   - `TokenManager.get_token()` integration for fresh access tokens
   - SASL XOAUTH2 format: `base64('user={email}\1auth=Bearer {token}\1\1')`[1]
4. Add `create_authenticator(auth_config)` factory function
5. Unit test both authenticators with mock IMAPClient

## 3. Refactor IMAP client initialization to use dynamic authenticator [pending]
### Dependencies: 11.1, 11.2
### Description: Replace hardcoded password login with config-driven authenticator selection and execution.
### Details:
1. In `AccountProcessor._connect_imap()`:
   - Replace `imap.login(email, password)` with `auth_config = self.get_auth_config()`
   - `authenticator = create_authenticator(auth_config)`
   - `authenticator.authenticate(self.imap_client)`
2. Preserve existing IMAPClient instantiation (host, port, ssl config)
3. Add timeout/retry logic around authentication
4. Integration test: full IMAP connection flow with both auth types
5. Verify capabilities check happens AFTER successful authentication

## 4. Add comprehensive error handling and validation [pending]
### Dependencies: 11.1, 11.2, 11.3
### Description: Implement robust error handling for missing configs, invalid tokens, network issues, and OAuth-specific failures.
### Details:
1. Config validation errors: `MissingAuthConfigError`, `InvalidOAuthConfigError`
2. Authenticator errors: `AuthenticationFailedError` wrapping IMAP exceptions
3. OAuth-specific: `TokenExpiredError`, `TokenFetchError` from TokenManager
4. Add `validate_auth_config()` method with specific validation per provider
5. Graceful degradation: log detailed errors but don't crash processor
6. Add retry logic for transient OAuth token fetch failures (max 3 attempts)
7. Integration tests for all error scenarios with pytest.raises()

## 5. Add end-to-end testing and security validation [pending]
### Dependencies: 11.1, 11.2, 11.3, 11.4
### Description: Create comprehensive integration tests and validate security best practices implementation.
### Details:
1. Integration test suite with mock IMAP server (imaplib2 or aiodns mock)
2. Test scenarios: password auth, OAuth success, OAuth token expiry/refresh, config errors
3. Security validation:
   - Verify no passwords/tokens logged in plaintext
   - TokenManager refresh called only when needed
   - XOAUTH2 base64 format correctly implemented per spec[1]
4. Performance tests: connection time < 10s for both auth types
5. Backward compatibility test: V4 configs continue working unchanged
6. Add pytest fixtures for TokenManager and config variants

