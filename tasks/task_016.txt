# Task ID: 16
# Title: Implement Configurable IMAP Query Filtering System
# Status: done
# Dependencies: 2
# Priority: low
# Description: Refactor the IMAP query combination logic to make idempotency tags and filtering criteria configurable by users instead of hardcoded values.
# Details:
Currently, the system hardcodes idempotency tags (Obsidian-Note-Created, Note-Creation-Failed, AIProcessed) in the IMAP query combination logic. This task involves:

1. Create a configuration system that allows users to specify which tags to exclude from IMAP queries
2. Implement a flexible query builder that can combine multiple filtering criteria beyond just tag exclusion
3. Design a clean API for the query builder that maintains backward compatibility
4. Update the existing query combination logic to use the new configurable system
5. Ensure the default configuration maintains current behavior (excluding the three idempotency tags)
6. Add appropriate documentation for the new configuration options
7. Consider implementing this as a strategy pattern where different query building strategies can be plugged in
8. Ensure performance is not significantly impacted, especially for large mailboxes
9. Add validation to prevent users from creating invalid query combinations

The implementation should be in the IMAP service module, focusing on the query building components. Maintain the core idempotency requirement while allowing for greater flexibility.

# Test Strategy:
Testing should cover:

1. Unit tests:
   - Verify default configuration produces the same queries as the current system
   - Test custom tag exclusion configurations work correctly
   - Test edge cases like empty exclusion lists or complex query combinations
   - Verify query syntax remains valid for the IMAP protocol

2. Integration tests:
   - Test the query builder with actual IMAP connections
   - Verify queries correctly filter messages as expected
   - Test performance with large mailboxes and complex queries

3. Configuration validation:
   - Test that invalid configurations are properly handled
   - Verify configuration changes are properly persisted

4. Backward compatibility:
   - Ensure existing code using the query system continues to work
   - Test migration from old to new system

Create a test matrix covering different combinations of filtering criteria to ensure all possible configurations work correctly. Document any changes to expected behavior.

# Subtasks:
## 1. Update ConfigManager with IMAP Query Exclusion Settings [done]
### Dependencies: None
### Description: Add a new configuration section for IMAP query exclusions with options to customize tag exclusions and disable idempotency checks.
### Details:
Implementation steps:
1. Add a new 'imap_query_exclusions' section to the ConfigManager class
2. Create the following configuration options:
   - exclude_tags: List of tags to exclude (default to ['Obsidian-Note-Created', 'Note-Creation-Failed', 'AIProcessed'])
   - additional_exclude_tags: List of additional tags to exclude (default to empty list)
   - disable_idempotency: Boolean flag to disable all tag exclusions (default to False)
3. Implement validation logic to ensure exclude_tags is a list of strings
4. Add methods to get the combined list of exclude_tags (base + additional)
5. Update config loading and validation functions

Testing approach:
- Unit test the ConfigManager with various valid and invalid configurations
- Test that default values are correctly applied when not specified
- Verify validation catches improper configuration types

<info added on 2026-01-07T17:29:56.868Z>
Correction to default tag names:
- The default exclude_tags should be ['AIProcessed', 'ObsidianNoteCreated', 'NoteCreationFailed'] as IMAP servers don't allow hyphens in flag names
- When implementing validation logic, add a check to ensure no tag contains hyphens or spaces
- Add a helper method to sanitize tag names by removing hyphens and converting to camelCase
- Consider adding a warning log when a user tries to configure tags with invalid characters
- Update documentation to clarify that IMAP flags must follow RFC3501 specifications (alphanumeric characters, underscores, and periods only)
</info added on 2026-01-07T17:29:56.868Z>

<info added on 2026-01-07T17:30:17.145Z>
<info added on 2026-01-08T14:22:31.452Z>
Implementation notes for tag handling:

1. Update the default exclude_tags to match the actual constants in the codebase:
   ```python
   # Use these constants from the codebase
   from constants import OBSIDIAN_NOTE_CREATED_TAG, NOTE_CREATION_FAILED_TAG, AI_PROCESSED_TAG
   
   # Default configuration
   DEFAULT_EXCLUDE_TAGS = [AI_PROCESSED_TAG, OBSIDIAN_NOTE_CREATED_TAG, NOTE_CREATION_FAILED_TAG]
   ```

2. Add a tag validation function to ensure IMAP compatibility:
   ```python
   def validate_imap_tag(tag):
       """Validates that a tag follows IMAP flag naming rules (RFC3501)"""
       import re
       if not re.match(r'^[\w.]+$', tag):
           raise ValueError(f"Invalid IMAP flag name: '{tag}'. IMAP flags must contain only alphanumeric characters, underscores, and periods.")
       return True
   ```

3. Implement a tag sanitization method to handle user input:
   ```python
   def sanitize_imap_tag(tag):
       """Converts a string to a valid IMAP flag name"""
       # Replace hyphens with nothing (camelCase convention)
       sanitized = re.sub(r'-(\w)', lambda m: m.group(1).upper(), tag)
       # Replace spaces with underscores
       sanitized = sanitized.replace(' ', '_')
       # Remove any remaining invalid characters
       sanitized = re.sub(r'[^\w.]', '', sanitized)
       
       if sanitized != tag:
           logger.warning(f"Tag '{tag}' was sanitized to '{sanitized}' to comply with IMAP flag requirements")
       
       return sanitized
   ```

4. Update the ConfigManager.validate_config method to check all tags:
   ```python
   # In the validate_config method
   if 'imap_query_exclusions' in config:
       exclusions = config['imap_query_exclusions']
       
       if 'exclude_tags' in exclusions:
           if not isinstance(exclusions['exclude_tags'], list):
               raise ValueError("exclude_tags must be a list of strings")
           for tag in exclusions['exclude_tags']:
               validate_imap_tag(tag)
               
       if 'additional_exclude_tags' in exclusions:
           if not isinstance(exclusions['additional_exclude_tags'], list):
               raise ValueError("additional_exclude_tags must be a list of strings")
           for tag in exclusions['additional_exclude_tags']:
               validate_imap_tag(tag)
   ```

5. Add a method to get sanitized tags when needed:
   ```python
   def get_sanitized_exclude_tags(self):
       """Returns the combined list of exclude tags, ensuring all are IMAP-compatible"""
       raw_tags = self.get_exclude_tags()
       return [sanitize_imap_tag(tag) for tag in raw_tags]
   ```

6. Add documentation in the config template:
   ```yaml
   # Example config.yaml section to add
   imap_query_exclusions:
     # Tags used to exclude emails from processing
     # IMPORTANT: IMAP flags must follow RFC3501 - only alphanumeric, underscore, period allowed
     exclude_tags: 
       - AIProcessed
       - ObsidianNoteCreated
       - NoteCreationFailed
     additional_exclude_tags: []
     disable_idempotency: false
   ```
</info added on 2026-01-08T14:22:31.452Z>
</info added on 2026-01-07T17:30:17.145Z>

## 2. Create Flexible IMAP Query Builder Function [done]
### Dependencies: 16.1
### Description: Implement a new function that builds IMAP queries with configurable exclusion tags and supports disabling idempotency checks.
### Details:
Implementation steps:
1. Create a new function `build_imap_query_with_exclusions()` in imap_connection.py that takes:
   - user_query: The base query string
   - exclude_tags: List of tags to exclude
   - disable_idempotency: Flag to bypass tag exclusions
2. Implement logic to build IMAP query with NOT KEYWORD clauses for each exclude tag
3. Handle special cases:
   - Empty exclude_tags list
   - When disable_idempotency is True (return user_query directly)
   - When user_query is empty or None
4. Ensure proper IMAP syntax with parentheses and operators

Testing approach:
- Unit test with various combinations of inputs
- Verify correct IMAP query syntax is generated
- Test edge cases (empty lists, None values, etc.)
- Benchmark query generation performance

## 3. Refactor search_emails_excluding_processed() Function [done]
### Dependencies: 16.2
### Description: Update the existing search function to use the new query builder while maintaining backward compatibility.
### Details:
Implementation steps:
1. Refactor search_emails_excluding_processed() to accept a list parameter 'exclude_tags' instead of individual tag parameters
2. Add a 'disable_idempotency' parameter with default value False
3. Use the new build_imap_query_with_exclusions() function internally
4. Maintain backward compatibility by setting default values that match current behavior
5. Update function documentation to reflect new parameters
6. Ensure error handling is consistent

Testing approach:
- Unit test the refactored function with various parameter combinations
- Verify backward compatibility with existing code
- Test that queries are correctly passed to the IMAP connection
- Test error handling scenarios

## 4. Update fetch_emails() Function Signature and Implementation [done]
### Dependencies: 16.3
### Description: Modify the fetch_emails() function to accept and pass through the new configuration parameters.
### Details:
Implementation steps:
1. Update the fetch_emails() function signature to accept:
   - exclude_tags parameter (default to None to use system defaults)
   - disable_idempotency parameter (default to False)
2. Pass these parameters to search_emails_excluding_processed() call
3. Update function documentation to explain the new parameters
4. Ensure backward compatibility with existing code
5. Add parameter validation if needed

Testing approach:
- Unit test with various parameter combinations
- Verify parameters are correctly passed to search_emails_excluding_processed()
- Test backward compatibility
- Integration test with mock IMAP server

## 5. Update main_loop.py to Use Configurable Query Parameters [done]
### Dependencies: 16.1, 16.4
### Description: Modify the main application loop to pass configuration values to the email fetching functions.
### Details:
Implementation steps:
1. Update the email processing code in main_loop.py to read the new configuration values
2. Pass config.exclude_tags and config.disable_idempotency to fetch_emails() calls
3. Ensure proper error handling if configuration is invalid
4. Add logging for which exclusion tags are being used
5. Consider adding a startup validation to warn about potentially problematic configurations

Testing approach:
- Integration test with different configuration settings
- Verify configuration values are correctly passed to fetch_emails()
- Test error handling for invalid configurations
- Test logging output

## 6. Implement Comprehensive Testing Suite [done]
### Dependencies: 16.1, 16.2, 16.3, 16.4, 16.5
### Description: Create a suite of unit and integration tests to verify the new query filtering system works correctly.
### Details:
Implementation steps:
1. Create unit tests for the new build_imap_query_with_exclusions() function
   - Test various combinations of queries and exclusion tags
   - Test edge cases (empty lists, None values)
   - Test disable_idempotency flag behavior
2. Create unit tests for the updated search_emails_excluding_processed() function
   - Test backward compatibility
   - Test with custom exclude_tags
3. Create integration tests that verify:
   - Default behavior matches current system
   - Custom configurations work as expected
   - Performance impact is acceptable
4. Test error handling and validation
5. Create test fixtures for different configuration scenarios

Testing approach:
- Use pytest for all tests
- Create mock IMAP server responses for integration tests
- Measure and compare performance with different configurations
- Test with large tag lists to ensure performance

## 7. Update Documentation and Configuration Examples [done]
### Dependencies: 16.1, 16.2, 16.3, 16.4, 16.5
### Description: Update user documentation and configuration examples to explain the new query filtering options.
### Details:
Implementation steps:
1. Update config.yaml.example with the new imap_query_exclusions section
   - Include commented examples of different configurations
   - Explain default values
2. Update COMPLETE_GUIDE.md with:
   - Explanation of the new configuration options
   - Examples of common use cases
   - Migration notes for existing users
3. Add inline code documentation for all new and modified functions
4. Create a specific section in the docs explaining the query filtering system
5. Add examples of how to use the system for different scenarios
6. Document any performance considerations

Testing approach:
- Review documentation for clarity and completeness
- Verify all examples are correct and work as described
- Have another team member review the documentation
- Ensure backward compatibility is clearly explained

