# Task ID: 10
# Title: Implement CLI authentication command
# Status: done
# Dependencies: 7, 8
# Priority: medium
# Description: Add the 'auth' command to the CLI for initiating OAuth flows
# Details:
In `src/cli_v4.py`:
1. Add a new `auth` command with `--account` parameter
2. Implement command handler that:
   - Loads the account configuration
   - Determines the provider (Google or Microsoft) from the config
   - Initializes the appropriate OAuth provider
   - Creates and runs the OAuth flow
   - Provides clear success/failure messages
3. Add help text and documentation for the command
4. Handle error cases gracefully with informative messages

# Test Strategy:
Write unit tests for the CLI command with mocked OAuth flows. Test with various account configurations. Test error handling for missing or invalid configurations.

# Subtasks:
## 1. Add auth command structure with --account parameter and help text [done]
### Dependencies: None
### Description: Create the basic Typer command structure in src/cli_v4.py with proper help documentation and parameter validation.
### Details:
Use @app.command() decorator to add 'auth' command. Add typer.Option('--account', required=True, help='Account name from config') parameter. Include comprehensive help text: 'Initiate OAuth 2.0 authentication flow for specified account'. Add validation to ensure account exists in config before proceeding. Follow Typer best practices for CLI consistency[1][3].

## 2. Implement account configuration loading and provider detection [done]
### Dependencies: 10.1
### Description: Create config loading logic that reads account settings and determines OAuth provider (Google/Microsoft).
### Details:
Load account config using existing config system (likely configparser or YAML). Extract provider field ('google' or 'microsoft') with validation. Raise typer.Exit(code=1, message='Account not found') for missing accounts. Log provider detection for debugging. Handle config file missing/permissions errors gracefully with user-friendly messages.

## 3. Initialize OAuth providers and implement OAuth flow orchestration [done]
### Dependencies: 10.2
### Description: Create OAuth provider initialization and flow execution with security best practices.
### Details:
Implement provider factory pattern: if provider=='google' → GoogleOAuthProvider(), else MicrosoftOAuthProvider(). Use secure redirect URIs and state parameters to prevent CSRF. Handle both local server callback and manual verification code flows. Store tokens securely (environment vars or encrypted keyring). Implement PKCE for public clients per OAuth 2.0 security best practices.

## 4. Add comprehensive success/failure messaging and error handling [done]
### Dependencies: 10.3
### Description: Implement user-facing messages and robust error handling for all failure scenarios.
### Details:
Provide clear success: '✅ Authentication successful for {account}! Tokens saved.' Handle specific errors: InvalidClientError, ConsentRequired, NetworkTimeout, etc. Use typer.echo() with emojis for visual clarity. Implement retry logic for transient errors (network timeouts). Gracefully handle Ctrl+C with cleanup. Ensure backward compatibility with V4 error format.

## 5. Add unit tests for auth command components [done]
### Dependencies: 10.1, 10.2, 10.3, 10.4
### Description: Create comprehensive test suite covering command invocation, config loading, provider detection, and error scenarios.
### Details:
Use typer.testing.CliRunner() for end-to-end CLI testing[1]. Mock config loader, OAuth providers, and token storage. Test scenarios: valid account success, missing account, invalid provider, network errors, Ctrl+C interrupt. Verify exit codes (0 success, 1 error) and message patterns. Test --help output. Aim for 90%+ coverage of auth command.

