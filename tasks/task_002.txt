# Task ID: 2
# Title: Define authentication interfaces and base classes
# Status: pending
# Dependencies: 1
# Priority: high
# Description: Implement the authenticator protocol and base classes for the strategy pattern
# Details:
In `src/auth/interfaces.py`:
1. Define `AuthenticatorProtocol` with `authenticate(imap_connection)` method
2. Create abstract base classes for providers: `OAuthProvider` with methods for generating auth URLs, handling callbacks, and token exchange
3. Define common interfaces and types for token management
4. Create utility functions for SASL string generation for XOAUTH2

Ensure all interfaces use proper type hints and docstrings for clarity.

# Test Strategy:
Write unit tests to verify interface definitions. Use static type checking with mypy to ensure protocol adherence.

# Subtasks:
## 1. Define AuthenticatorProtocol and core type aliases [pending]
### Dependencies: None
### Description: Create the main protocol interface and essential type definitions for token management with proper type hints and docstrings.
### Details:
In `src/auth/interfaces.py`:
- Define `AuthenticatorProtocol` (Protocol) with `authenticate(imap_connection: IMAP4_SSL) -> bool` method and comprehensive docstring explaining IMAP SASL XOAUTH2 usage.
- Add `TokenInfo = TypedDict('TokenInfo', {'access_token': str, 'expires_at': Optional[datetime], 'refresh_token': Optional[str]})` for OAuth token structure.
- Define `OAuthConfig = TypedDict('OAuthConfig', {'client_id': str, 'client_secret': str, 'redirect_uri': str, 'scopes': list[str], 'auth_url': str, 'token_url': str})`.
- Include validation for required OAuth 2.0 security parameters per RFC 6749.

## 2. Implement OAuthProvider abstract base class [pending]
### Dependencies: 2.1
### Description: Create the base ABC for OAuth providers implementing strategy pattern with core OAuth 2.0 Authorization Code Flow methods.
### Details:
Define `OAuthProvider(ABC)` with:
- `@abstractmethod def get_auth_url(state: str) -> str`: Generates authorization URL with PKCE challenge if supported.
- `@abstractmethod def handle_callback(code: str, state: str) -> TokenInfo`: Exchanges code for tokens.
- `@abstractmethod def refresh_token(token_info: TokenInfo) -> TokenInfo`: Handles token refresh.
- `validate_token(token_info: TokenInfo) -> bool`: Checks expiration with 5min buffer.
- Include docstrings referencing OAuth 2.0 RFCs and security best practices (state validation, PKCE).

## 3. Add token management utilities and error handling [pending]
### Dependencies: 2.1, 2.2
### Description: Implement common token utilities and comprehensive error handling interfaces for robust OAuth implementation.
### Details:
Add to `interfaces.py`:
- `TokenError`, `OAuthError`, `AuthExpiredError` custom exceptions with proper inheritance.
- `is_token_valid(token_info: TokenInfo, clock_skew: int = 300) -> bool`: Expiration validation utility.
- `parse_token_response(response: dict) -> TokenInfo`: Safe JSON parsing with validation.
- `generate_state() -> str` and `generate_pkce_challenge() -> tuple[str, str]`: Security utilities.
- Define `ProviderFactory = Callable[[OAuthConfig], OAuthProvider]` protocol for dependency injection.

## 4. Implement XOAUTH2 SASL utilities [pending]
### Dependencies: 2.1
### Description: Create SASL string generation functions specifically for IMAP XOAUTH2 authentication per RFC 7628.
### Details:
Add SASL utilities:
- `generate_xoauth2_sasl(user: str, access_token: str) -> bytes`: Implements base64('user=' + user + '^Aauth=Bearer ' + token + '^A^A').
- `validate_sasl_components(user: str, token: str) -> None`: Input validation.
- Include unit test functions: `test_sasl_base64_encoding()`, `test_sasl_format_rfc7628()`.
- Docstrings must reference RFC 7628 XOAUTH2 specification and include example SASL strings.

## 5. Add comprehensive docstrings and type validation tests [pending]
### Dependencies: 2.1, 2.2, 2.3, 2.4
### Description: Complete interfaces with full documentation, backward compatibility checks, and interface compliance tests.
### Details:
Finalize with:
- Google-style docstrings for all protocols/ABCs with Args, Returns, Raises sections.
- V4 compatibility: `is_v4_compatible(provider: OAuthProvider) -> bool` utility.
- Test subtasks: `test_protocol_compliance()`, `test_type_hints_mypy()`, `test_docstring_coverage()`, `test_sasl_roundtrip()`.
- Add `__all__ = [...]` export list and `version = '1.0.0'` for backward compatibility tracking.

