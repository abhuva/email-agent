# Task ID: 9
# Title: Implement note creation and email tagging workflow
# Status: pending
# Dependencies: 2, 3, 8
# Priority: high
# Description: Create the core workflow that processes emails, creates notes, and applies appropriate tags
# Details:
Implement the main workflow that: 1) Processes each selected email, 2) Generates the Markdown note content, 3) Writes the file to the configured location, 4) Tags the email with [Obsidian-Note-Created] on success or [Note-Creation-Failed] on failure. Include comprehensive error handling at each step, ensuring the email is always tagged appropriately based on the outcome.

# Test Strategy:
Test the complete workflow with various email scenarios. Verify files are created correctly and emails are tagged appropriately. Test error handling by simulating failures at different stages of the process.

# Subtasks:
## 1. Implement email processing loop with initial error handling [pending]
### Dependencies: None
### Description: Create the main workflow function that iterates through selected emails and sets up comprehensive error handling structure with success/failure tracking.
### Details:
1. Create async function `processSelectedEmails()` that accepts array of selected email objects. 2. Initialize tracking variables: `successCount`, `failureCount`, `results[]`. 3. Implement try-catch wrapper around entire loop with `finally` block to ensure email tagging occurs regardless of outcome. 4. For each email, extract core metadata (subject, sender, date, body) into structured object. 5. Log processing start for each email with unique identifier.

## 2. Implement Markdown note content generation [pending]
### Dependencies: 9.1
### Description: Create function to convert email data into properly formatted Markdown note content with Obsidian-compatible frontmatter.
### Details:
1. Create `generateMarkdownNote(emailData)` function that returns complete Markdown string. 2. Add YAML frontmatter with `title: email.subject`, `email: sender.email`, `date: email.date`, `tags: ['email', 'inbox']`. 3. Convert email body to Markdown using HTML-to-Markdown library if HTML, preserve plain text otherwise. 4. Include sender signature block with reply link. 5. Add email metadata section (To/CC, attachments list). 6. Sanitize filename from subject (remove invalid chars, limit length). 7. Include comprehensive error handling with descriptive error messages.

## 3. Implement note file writing with path resolution [pending]
### Dependencies: 9.1, 9.2
### Description: Create file writing function that resolves configured output path and writes Markdown content with proper filename.
### Details:
1. Create `writeNoteFile(markdownContent, filename)` function. 2. Read configured output directory from settings (e.g., `app.settings.get('notesOutputPath')`). 3. Ensure output directory exists using `fs.ensureDir()`. 4. Generate safe filename: `${sanitizedSubject}-${timestamp}.md`. 5. Write file with UTF-8 encoding using `fs.writeFile()`. 6. Return file path on success or throw specific `FileWriteError` on failure. 7. Implement atomic write (temp file + rename) for reliability. 8. Add file existence check to prevent overwrites.

## 4. Implement success email tagging mechanism [pending]
### Dependencies: 9.1
### Description: Create function to apply [Obsidian-Note-Created] tag to successfully processed emails with note file path reference.
### Details:
1. Create `tagEmailSuccess(emailId, notePath)` function. 2. Use email client API to add label/tag `[Obsidian-Note-Created]`. 3. Optionally append note filepath to email subject or comments field. 4. Implement idempotency check (don't re-tag if already tagged). 5. Log success with email ID, note path, and timestamp. 6. Return success metadata for workflow tracking.

## 5. Implement failure email tagging and complete workflow integration [pending]
### Dependencies: 9.1, 9.2, 9.3, 9.4
### Description: Integrate all components into complete workflow with failure tagging [Note-Creation-Failed] and detailed error reporting.
### Details:
1. In main workflow loop, call generateMarkdownNote → writeNoteFile → tagEmailSuccess sequence. 2. Catch specific errors at each step and map to `tagEmailFailure(emailId, errorMessage)`. 3. Create `tagEmailFailure(emailId, error)` function that applies [Note-Creation-Failed] tag. 4. Store detailed error info in email comments/subject or separate log. 5. Implement retry logic for transient failures (network, permissions). 6. Add final workflow summary: total processed, successes, failures with error breakdown. 7. Ensure 100% email tagging coverage via finally blocks.

