# Task ID: 3
# Title: Update configuration schema for OAuth support
# Status: pending
# Dependencies: 1
# Priority: high
# Description: Modify the configuration schema to include OAuth authentication options
# Details:
1. Update `src/config_schema.py` to include the new `auth` block in account configuration
2. Implement validation for the auth block using Pydantic discriminated unions:
   - If `method="oauth"`, then `provider` is mandatory and `password_env` is ignored
   - If `method="password"`, `password_env` is mandatory
3. Set default value for `method` as `"password"` for backward compatibility
4. Add validation for `provider` field to accept only `"google"` or `"microsoft"`
5. Ensure the schema maintains backward compatibility with existing configurations

# Test Strategy:
Write unit tests with various configuration scenarios: missing auth block, oauth method without provider, password method without password_env, etc. Verify backward compatibility with existing V4 configurations.

# Subtasks:
## 1. Add OAuth auth block to base config schema [pending]
### Dependencies: None
### Description: Update `src/config_schema.py` to include the new `auth` block with discriminated union structure and default values for backward compatibility.
### Details:
Define Pydantic BaseModel for `AuthConfig` using discriminated unions with `method: Literal['password', 'oauth'] = 'password'`. Add `provider: Optional[Literal['google', 'microsoft']] = None` and `password_env: Optional[str] = None`. Nest within existing account configuration structure. Ensure existing configs without `auth` block default to `method='password'`.

## 2. Implement conditional validation logic for auth methods [pending]
### Dependencies: 3.1
### Description: Add Pydantic validators to enforce conditional field requirements based on `method` value.
### Details:
Use `@validator('provider', 'password_env', pre=True)` or `@root_validator` to implement logic: when `method == 'oauth'`, require `provider` and ignore `password_env`; when `method == 'password'`, require `password_env`. Raise `ValueError` with clear messages for security best practices. Test edge cases like missing fields.

## 3. Add provider enum validation and OAuth 2.0 fields [pending]
### Dependencies: 3.1
### Description: Restrict `provider` to Google/Microsoft and add OAuth 2.0 specific configuration fields.
### Details:
Create `OAuthProviderConfig` model with `client_id`, `client_secret_env`, `redirect_uri`, and `scopes: List[str] = []` fields following OAuth 2.0 standards from Google/Microsoft docs. Embed within `auth` block when `provider` is set. Include `access_type: str = 'offline'` and `include_granted_scopes: bool = True` for best practices.

## 4. Ensure V4 backward compatibility and migration handling [pending]
### Dependencies: 3.1, 3.2, 3.3
### Description: Verify existing V4 configurations parse correctly and add migration warnings.
### Details:
Test parsing of V4 configs missing `auth` block (should default to password). Add `deprecated` field warnings for configs without explicit `method`. Implement custom `Config` class with `extra='ignore'` or `allow_population_by_field_name=True`. Log deprecation warnings for `password`-only configs.

## 5. Add comprehensive unit tests for auth schema validation [pending]
### Dependencies: 3.1, 3.2, 3.3, 3.4
### Description: Create test suite covering all validation paths, edge cases, and backward compatibility.
### Details:
Write pytest cases for: 1) Valid OAuth configs (google/microsoft), 2) Valid password configs, 3) Invalid provider values, 4) Missing required fields per method, 5) V4 backward compatibility, 6) Extra unknown fields ignored, 7) Default `method='password'` behavior. Target 100% validation path coverage.

