# Task ID: 3
# Title: Create IMAP connection and email retrieval module
# Status: done
# Dependencies: 1
# Priority: high
# Description: Develop a module to handle IMAP server connection and email retrieval with support for UID-based targeting.
# Details:
Implement an IMAP client module (src/imap_client.py) that connects to the server using credentials from the settings.py facade. Create functions to retrieve emails by UID, fetch all unprocessed emails, and handle IMAP flags. Include error handling for connection issues and authentication failures. Implement a function to check if an email has already been processed based on IMAP flags. All configuration access must be through the settings.py facade, not directly from YAML.

# Test Strategy:
Test connection with valid and invalid credentials. Verify email retrieval by UID works correctly. Test flag checking functionality with processed and unprocessed emails.

# Subtasks:
## 1. Implement IMAP connection setup with settings facade [done]
### Dependencies: None
### Description: Create a module that establishes a connection to an IMAP server using credentials from settings.py facade
### Details:
Create an ImapClient class in src/imap_client.py that loads server details (host, port, username, password) from the settings.py facade, not directly from config.yaml. Implement a connect() method that establishes a secure connection to the IMAP server using the imaplib library. Include proper error handling for connection failures, authentication issues, and configuration errors. The connection should be reusable and support timeout configurations.

## 2. Develop email retrieval by UID functionality [done]
### Dependencies: 3.1
### Description: Create functions to fetch specific emails by their unique identifiers (UIDs)
### Details:
Add a get_email_by_uid(uid) method to the ImapClient class that retrieves a specific email using its UID. The method should return the email in a structured format (headers, body parts, attachments). Implement proper error handling for cases where the UID doesn't exist or when fetch operations fail. Include support for different email formats (plain text, HTML, multipart). Use the settings.py facade for any configuration values needed.

## 3. Implement batch email retrieval for unprocessed messages [done]
### Dependencies: 3.1
### Description: Create functionality to fetch all unprocessed emails from the IMAP server
### Details:
Add a get_unprocessed_emails() method to the ImapClient class that searches for and retrieves all emails that haven't been processed yet (based on absence of specific flags from settings.get_imap_processed_tag()). The method should return a list of email objects with their UIDs. Implement pagination or batching for servers with many emails to prevent memory issues. Include search criteria customization options. Use the settings.py facade for all configuration values.

## 4. Develop IMAP flag management functionality [done]
### Dependencies: 3.1
### Description: Create methods to check, set, and clear IMAP flags on email messages
### Details:
Add methods to the ImapClient class for flag management: set_flag(uid, flag), clear_flag(uid, flag), and has_flag(uid, flag). These methods should handle standard IMAP flags (\Seen, \Answered, \Flagged, \Deleted, \Draft) as well as custom flags. Implement proper error handling for flag operations and support batch operations for multiple UIDs. Use the settings.py facade to access the processed tag name (settings.get_imap_processed_tag()).

## 5. Implement processed email tracking mechanism [done]
### Dependencies: 3.2, 3.4
### Description: Create functionality to track which emails have already been processed
### Details:
Implement a is_processed(uid) method that checks if an email has been processed based on IMAP flags (using the processed tag from settings.get_imap_processed_tag(), which should be 'AIProcessed' according to the PDD). Add a mark_as_processed(uid) method that sets the appropriate flag. Create a helper function get_next_unprocessed_email() that returns the next email that needs processing. Include options to customize which flags indicate processed status. All configuration values must be accessed through the settings.py facade.

