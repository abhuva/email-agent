name: CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Run Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-cov pytest-html pytest-xdist
    
    - name: Create test config directory
      run: |
        python -c "from pathlib import Path; Path('config').mkdir(exist_ok=True)"
    
    - name: Create test config file
      run: |
        python -c "
        from pathlib import Path
        import shutil
        import os
        
        # Create required directories
        Path('config').mkdir(exist_ok=True)
        Path('logs').mkdir(exist_ok=True)
        
        # Create obsidian vault directory (use temp dir that works on both OS)
        if os.name == 'nt':  # Windows
            vault_path = os.path.join(os.environ.get('TEMP', 'C:\\temp'), 'test_vault')
        else:  # Unix/Linux
            vault_path = '/tmp/test_vault'
        Path(vault_path).mkdir(parents=True, exist_ok=True)
        
        # Create minimal required files if they don't exist
        prompt_file = Path('config/prompt.md')
        if not prompt_file.exists():
            prompt_file.write_text('# Test Prompt\n\nAnalyze this email.')
        
        template_file = Path('config/note_template.md.j2')
        if not template_file.exists():
            template_file.write_text('---\nuid: {{ uid }}\n---\n\n# {{ subject }}\n\n{{ body }}')
        
        # Copy example config or create minimal one
        config_example = Path('config/config.yaml.example')
        config_file = Path('config/config.yaml')
        if config_example.exists() and not config_file.exists():
            shutil.copy(config_example, config_file)
        elif not config_file.exists():
            # Create minimal config using string formatting
            config_lines = [
                'imap:',
                '  server: test.imap.com',
                '  port: 993',
                '  username: test@example.com',
                '  password_env: IMAP_PASSWORD',
                '  query: ALL',
                '  processed_tag: AIProcessed',
                '  application_flags:',
                '    - AIProcessed',
                '    - ObsidianNoteCreated',
                '    - NoteCreationFailed',
                'paths:',
                '  template_file: config/note_template.md.j2',
                f'  obsidian_vault: {vault_path}',
                '  log_file: logs/agent.log',
                '  analytics_file: logs/analytics.jsonl',
                '  changelog_path: logs/email_changelog.md',
                '  prompt_file: config/prompt.md',
                'openrouter:',
                '  api_key_env: OPENROUTER_API_KEY',
                '  api_url: https://openrouter.ai/api/v1',
                'classification:',
                '  model: google/gemini-2.5-flash-lite-preview-09-2025',
                '  temperature: 0.2',
                '  retry_attempts: 3',
                '  retry_delay_seconds: 5',
                'processing:',
                '  importance_threshold: 8',
                '  spam_threshold: 5',
                '  max_body_chars: 4000',
                '  max_emails_per_run: 15'
            ]
            config_content = '\\n'.join(config_lines)
            config_file.write_text(config_content)
        "
      continue-on-error: true
    
    - name: Create test environment file
      run: |
        python -c "
        from pathlib import Path
        env_file = Path('.env')
        env_file.write_text('IMAP_PASSWORD=test_password\nOPENROUTER_API_KEY=test_api_key\n')
        "
      continue-on-error: true
    
    - name: Run all non-E2E tests
      run: |
        pytest tests/ -v -m "not e2e_imap and not e2e_llm" --tb=short --junitxml=junit-all.xml --cov=src --cov-report=xml --cov-report=term-missing --cov-report=html
      continue-on-error: false
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
        path: |
          junit-*.xml
          htmlcov/
        retention-days: 30
    
    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: junit-*.xml
        check_name: Test Results (${{ matrix.os }}, Python ${{ matrix.python-version }})

  test-e2e:
    name: E2E Tests (Optional)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-e2e-tests')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create test config
      env:
        TEST_IMAP_SERVER: ${{ secrets.TEST_IMAP_SERVER }}
        TEST_IMAP_USERNAME: ${{ secrets.TEST_IMAP_USERNAME }}
      run: |
        python -c "
        from pathlib import Path
        import os
        
        Path('config').mkdir(exist_ok=True)
        Path('logs').mkdir(exist_ok=True)
        Path('/tmp/test_vault').mkdir(parents=True, exist_ok=True)
        
        # Create required files
        prompt_file = Path('config/prompt.md')
        if not prompt_file.exists():
            prompt_file.write_text('# Test Prompt\n\nAnalyze this email.')
        
        template_file = Path('config/note_template.md.j2')
        if not template_file.exists():
            template_file.write_text('---\nuid: {{ uid }}\n---\n\n# {{ subject }}\n\n{{ body }}')
        
        config_file = Path('config/config.yaml')
        if not config_file.exists():
            imap_server = os.environ.get('TEST_IMAP_SERVER', 'test.imap.com')
            imap_username = os.environ.get('TEST_IMAP_USERNAME', 'test@example.com')
            config_lines = [
                'imap:',
                f'  server: {imap_server}',
                '  port: 993',
                f'  username: {imap_username}',
                '  password_env: IMAP_PASSWORD',
                '  query: UNSEEN',
                '  processed_tag: AIProcessed',
                '  application_flags:',
                '    - AIProcessed',
                '    - ObsidianNoteCreated',
                '    - NoteCreationFailed',
                'paths:',
                '  template_file: config/note_template.md.j2',
                '  obsidian_vault: /tmp/test_vault',
                '  log_file: logs/agent.log',
                '  analytics_file: logs/analytics.jsonl',
                '  changelog_path: logs/email_changelog.md',
                '  prompt_file: config/prompt.md',
                'openrouter:',
                '  api_key_env: OPENROUTER_API_KEY',
                '  api_url: https://openrouter.ai/api/v1',
                'classification:',
                '  model: google/gemini-2.5-flash-lite-preview-09-2025',
                '  temperature: 0.2',
                '  retry_attempts: 3',
                '  retry_delay_seconds: 5',
                'processing:',
                '  importance_threshold: 8',
                '  spam_threshold: 5',
                '  max_body_chars: 4000',
                '  max_emails_per_run: 15'
            ]
            config_content = '\\n'.join(config_lines)
            config_file.write_text(config_content)
        "
    
    - name: Set up environment variables
      env:
        IMAP_PASSWORD: ${{ secrets.TEST_IMAP_PASSWORD }}
        OPENROUTER_API_KEY: ${{ secrets.TEST_OPENROUTER_API_KEY }}
      run: |
        python -c "
        from pathlib import Path
        import os
        env_file = Path('.env')
        env_file.write_text(f'IMAP_PASSWORD={os.environ[\"IMAP_PASSWORD\"]}\nOPENROUTER_API_KEY={os.environ[\"OPENROUTER_API_KEY\"]}\n')
        "
    
    - name: Run E2E IMAP tests
      env:
        IMAP_PASSWORD: ${{ secrets.TEST_IMAP_PASSWORD }}
      run: |
        pytest tests/test_e2e_imap.py -v --tb=short --junitxml=junit-e2e-imap.xml
      continue-on-error: true
    
    - name: Run E2E LLM tests
      env:
        OPENROUTER_API_KEY: ${{ secrets.TEST_OPENROUTER_API_KEY }}
      run: |
        pytest tests/test_e2e_llm.py -v --tb=short --junitxml=junit-e2e-llm.xml
      continue-on-error: true
    
    - name: Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: junit-e2e-*.xml
        retention-days: 30

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
      continue-on-error: true
    
    - name: Check code formatting with black
      run: |
        black --check src/ tests/ || echo "Black check failed - consider running 'black src/ tests/'"
      continue-on-error: true
    
    - name: Check import sorting with isort
      run: |
        isort --check-only src/ tests/ || echo "isort check failed - consider running 'isort src/ tests/'"
      continue-on-error: true
    
    - name: Lint with flake8
      run: |
        flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Flake8 found issues"
      continue-on-error: true
