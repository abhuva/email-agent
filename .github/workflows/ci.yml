name: CI Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Run Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-cov pytest-html pytest-xdist
    
    - name: Create test config directory
      shell: bash
      run: |
        mkdir -p config
        if [ ! -f config/config.yaml ]; then
          cp config/config.yaml.example config/config.yaml 2>/dev/null || echo "No example config found"
        fi
    
    - name: Create test environment file
      shell: bash
      run: |
        echo "# Test environment variables" > .env
        echo "IMAP_PASSWORD=test_password" >> .env
        echo "OPENROUTER_API_KEY=test_api_key" >> .env
      continue-on-error: true
    
    - name: Run unit tests
      run: |
        pytest tests/ -v -m "unit" --tb=short --junitxml=junit-unit.xml --cov=src --cov-report=xml --cov-report=term-missing
      continue-on-error: false
    
    - name: Run integration tests
      run: |
        pytest tests/ -v -m "integration" --tb=short --junitxml=junit-integration.xml
      continue-on-error: false
    
    - name: Run all non-E2E tests
      run: |
        pytest tests/ -v -m "not e2e_imap and not e2e_llm" --tb=short --junitxml=junit-all.xml --cov=src --cov-report=xml --cov-report=term-missing --cov-report=html
      continue-on-error: false
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
        path: |
          junit-*.xml
          htmlcov/
        retention-days: 30
    
    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: junit-*.xml
        check_name: Test Results (${{ matrix.os }}, Python ${{ matrix.python-version }})

  test-e2e:
    name: E2E Tests (Optional)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-e2e-tests')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create test config
      shell: bash
      run: |
        mkdir -p config
        # Use provided config or create minimal test config
        if [ ! -f config/config.yaml ]; then
          cat > config/config.yaml << 'EOF'
        imap:
          server: \${{ secrets.TEST_IMAP_SERVER }}
          port: 993
          username: \${{ secrets.TEST_IMAP_USERNAME }}
          password_env: 'IMAP_PASSWORD'
          query: 'UNSEEN'
          processed_tag: 'AIProcessed'
        paths:
          template_file: 'config/note_template.md.j2'
          obsidian_vault: '/tmp/test_vault'
          log_file: 'logs/agent.log'
          analytics_file: 'logs/analytics.jsonl'
          changelog_path: 'logs/email_changelog.md'
          prompt_file: 'config/prompt.md'
        openrouter:
          api_key_env: 'OPENROUTER_API_KEY'
          api_url: 'https://openrouter.ai/api/v1'
          model: 'google/gemini-2.5-flash-lite-preview-09-2025'
          temperature: 0.2
          retry_attempts: 3
          retry_delay_seconds: 5
        processing:
          importance_threshold: 8
          spam_threshold: 5
          max_body_chars: 4000
          max_emails_per_run: 15
        EOF
        fi
    
    - name: Set up environment variables
      shell: bash
      env:
        IMAP_PASSWORD: ${{ secrets.TEST_IMAP_PASSWORD }}
        OPENROUTER_API_KEY: ${{ secrets.TEST_OPENROUTER_API_KEY }}
      run: |
        echo "IMAP_PASSWORD=$IMAP_PASSWORD" > .env
        echo "OPENROUTER_API_KEY=$OPENROUTER_API_KEY" >> .env
    
    - name: Run E2E IMAP tests
      env:
        IMAP_PASSWORD: ${{ secrets.TEST_IMAP_PASSWORD }}
      run: |
        pytest tests/test_e2e_imap.py -v --tb=short --junitxml=junit-e2e-imap.xml
      continue-on-error: true
    
    - name: Run E2E LLM tests
      env:
        OPENROUTER_API_KEY: ${{ secrets.TEST_OPENROUTER_API_KEY }}
      run: |
        pytest tests/test_e2e_llm.py -v --tb=short --junitxml=junit-e2e-llm.xml
      continue-on-error: true
    
    - name: Upload E2E test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: e2e-test-results
        path: junit-e2e-*.xml
        retention-days: 30

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
      continue-on-error: true
    
    - name: Check code formatting with black
      run: |
        black --check src/ tests/ || echo "Black check failed - consider running 'black src/ tests/'"
      continue-on-error: true
    
    - name: Check import sorting with isort
      run: |
        isort --check-only src/ tests/ || echo "isort check failed - consider running 'isort src/ tests/'"
      continue-on-error: true
    
    - name: Lint with flake8
      run: |
        flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Flake8 found issues"
      continue-on-error: true
